<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=EUC-KR">
  <title>책정보 보기</title>
  <script type="text/javascript" src="ajax.js"></script>
  <script type="text/javascript">
  var xmlDoc = null;
  var xslDoc = null;

  function loadBooks() {
	new  ajax.xhr.Request("books.jsp", null, loadBooksXML, "GET");
    new  ajax.xhr.Request("books.xsl", null, loadBooksXSL, "GET");
  }
    
  function loadBooksXML(reg) {
    if (reg.readyState == 4) {
      if (reg.status == 200) {
        xmlDoc = reg.responseXML;
        doXSLT();
      }
    }
  }
  
  function loadBooksXSL(reg) {
    if (reg.readyState == 4) {
      if (reg.status == 200) {
        xslDoc = reg.responseXML;
        doXSLT();
      }
    }
  }
	
  function doXSLT() {
    if (xmlDoc == null || xslDoc == null) return;
    
    var msg_id = document.getElementById("xmlList");
    
    if (window.ActiveXObject) {
      msg_id.innerHTML = xmlDoc.transformNode(xslDoc);
    } else {
      var xsltProc = new XSLTProcessor();
      xsltProc.importStylesheet(xslDoc);
      var fragment = xsltProc.transformToFragment(xmlDoc, document);
      msg_id.appendChild(fragment);
    }
  } 

  //xpath를 이용한 노드 얻기    
  /*
    parent : 상위 node
    path : node을 찾을 조건 식 
  */
  function getXPath2Node(parentNode, path) {  
    var node;
    if (document.evaluate == null) {
      node = parentNode.selectSingleNode(path);
    } else {
      var result = document.evaluate(path, 
                  parentNode,
                  null, 
                  XPathResult.FIRST_ORDERED_NODE_TYPE , 
                  null );
      node = result.singleNodeValue;
    }
    return node;
  }

  //부모노드을 입력 인자로 해서 하위 노드의 문자열을 얻는다 .
  function getChildNodeValue(parent, nodeName) {
    var node = getXPath2Node(parent, "./" + nodeName);
    if (node == null) return "";
    
    var childList = node.childNodes;
    for (var i=0;i<childList.length;i++) {
      //Text 문자열을 얻는다.
      if (childList[i].nodeType == 3) {
        return childList[i].nodeValue;
      }
    }
    return "";
  }

  function elementView(isbn) {
    var node = getXPath2Node(xmlDoc, ".//book/isbn[. = '"+isbn+"']");
    var parentNode = node.parentNode;

    alert(getChildNodeValue(parentNode, "isbn"));
    alert(getChildNodeValue(parentNode, "title"));
    alert(getChildNodeValue(parentNode, "author"));
  }

  function elementDelete(isbn) {
    var node = getXPath2Node(xmlDoc, ".//book/isbn[. = '"+isbn+"']");
    var parentNode = node.parentNode;
    //XML DOM 노드 제거 
    parentNode.parentNode.removeChild(parentNode);
    
    //HTML 객체 삭제 
    var obj = document.getElementById(isbn);
    obj.parentNode.removeChild(obj);
  }

  function elementInsertMethod() {
    //root 요소를 얻는다.
    var root = xmlDoc.documentElement;
    
    //book 요소를 생성한다.
    var book = xmlDoc.createElement("book");
    //isbn 요소를 생성한다.
    var isbn = xmlDoc.createElement("book");
    //title 요소를 생성한다.
    var title = xmlDoc.createElement("book");
    //author 요소를 생성한다.
    var author = xmlDoc.createElement("book");
    
    //book 요소의 하위에 isbn 요소를 삽입한다.
    book.appendChild(idbn);
    //book 요소의 하위에 title 요소를 삽입한다.
    book.appendChild(title);
    //book 요소의 하위에 author 요소를 삽입한다.
    book.appendChild(author);

    //isbn 요소의 하위에 문자열노드를 생성한 후 추가한다.
    isbn.appendChild(xmlDoc.createTextNode("12-1234-123-5"));
    //title 요소의 하위에 문자열노드를 생성한 후 추가한다.
    title.appendChild(xmlDoc.createTextNode("타짜"));
    //author 요소의 하위에 문자열노드를 생성한 후 추가한다.
    author.appendChild(xmlDoc.createTextNode("허영만"));
    
    //루트 노드에 book 노드를 삽입한다 .
    root.appendChild(book);
    
    //화면에 출력한다 .
    doXSLT();
  }  

  function elementInsert() {
    if (window.ActiveXObject != null) {
      //root 요소를 얻는다.
      var root = xmlDoc.documentElement;
      //book 요소를 생성한다.
      var book = xmlDoc.createElement("book");
      //isbn 요소를 생성한다.
      var isbn = xmlDoc.createElement("book");
      //title 요소를 생성한다.
      var title = xmlDoc.createElement("book");
      //author 요소를 생성한다.
      var author = xmlDoc.createElement("book");
      //book 요소의 하위에 isbn 요소를 삽입한다.
      book.appendChild(      
    } else {
      nodeDoc = (new DOMParser()).parseFromString("<book><isbn>aaa</isbn><title>bbb</title><author>cccc</author></book>","text/xml"); 
      rootNode = getXPath2Node(nodeDoc, ".//book");
      xmlDoc.documentElement.appendChild(rootNode);
      doXSLT();
      //newNode = nodeDOc.documentElement.cloneNode(true);
      
    }
  }
  
  window.onload = function() {
    loadBooks();
  }

  </script>
</head>
<body>
신규책 목록 
<div id="xmlList"></div>
<a href="javascript:elementInsertMethod()">삽입</a>
</body>
</html>