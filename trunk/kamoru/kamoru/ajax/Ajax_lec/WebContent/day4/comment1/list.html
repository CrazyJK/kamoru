<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=EUC-KR">
  <title>댓글 목록</title>
  <style type="text/css">
    ul {
      margin: 0px 0px;
      border-style: solid;
      border-width: 0px;
      padding: 1px 1px;
    }
    li {
      list-style-type: none; 
    }
  </style>
  <script type="text/javascript" src="ajax.js"></script>
  <script type="text/javascript">
  //XML Document 객체 생성  
  var xmlObj = new ajax.xml.Document();
  var tmpUL;
  
  function loadBooks() {
	  new  ajax.xhr.Request("list.jsp", null, loadBooksXML, "GET");
    new  ajax.xhr.Request("comment.xsl", null, loadBooksXSL, "GET");
  }
    
  function loadBooksXML(reg) {
    if (reg.readyState == 4) {
      if (reg.status == 200) {
        xmlObj.xmlDoc = reg.responseXML;
        doXSLT();
      }
    }
  }
  
  function loadBooksXSL(reg) {
    if (reg.readyState == 4) {
      if (reg.status == 200) {
        xmlObj.xslDoc = reg.responseXML;
        doXSLT();
      }
    }
  }
	
  function doXSLT() {
    if (xmlObj.xmlDoc == null || xmlObj.xslDoc == null) return;
    
    var list = document.getElementById("list");
    
    xmlObj.transformXmlDoc(list);
  } 

  //덧글 등록 및 수정 양식 화면관리하는 함수 
  function insertFormVisible(visible) {
    var insert = document.getElementById("insert");
    var update = document.getElementById("update");
    
    if (visible == true) {
      insert.style.display = "block";    
      update.style.display = "none";    
    } else {
      insert.style.display = "none";    
      update.style.display = "block";    
    }
  }
  
  function commentUpdateForm(id, obj) {
    
    var node = xmlObj.selectSingleNode("//comment[@id = '"+id+"']");
    
    if (node == null) return;
    var updateForm = document.updateForm;
    updateForm.id.value      = node.getAttribute("id");
    updateForm.name.value    = xmlObj.getNodeValue(node, "name");
    updateForm.content.value = xmlObj.getNodeValue(node, "content");

    //현재버튼이 속한 UL 개체를 얻는다.    
    tmpUL = obj.parentNode.parentNode;
    
    //수정화면을 보여준다.
    insertFormVisible(false);
  }

  function commentUpdate() {
    
    var updateForm = document.updateForm;
    var node = xmlObj.selectSingleNode("//comment[@id = '"+updateForm.id.value+"']");
    
    if (node == null) return;
    //등록화면을 보여준다.
    insertFormVisible(true);
    
    xmlObj.setNodeValue(node, "name", updateForm.name.value);
    xmlObj.setNodeValue(node, "content", updateForm.content.value);

    //화면에 변경된 자료를 작용한다.
    xmlObj.transformNodes(tmpUL, node, false);

    //comment 노드를 출력한 UL 개체를 초기화 한다.    
    tmpUL = null;
  }

  function cancelUpdate() {
    //등록화면을 보여준다.
    insertFormVisible(true);
  }
  
  function commentDelete(id, obj) {
    //XPath를 이용하여 xml 문서객체에서 제거한다.
    xmlObj.removeNodes("//comment[@id = '"+id+"']");
    
    //현재버튼이 속한 UL 개체의 부모노드를 얻는다.    
    var parentNode = obj.parentNode.parentNode.parentNode;
    //현재버튼이 속한 UL 개체를 제거한다.
    parentNode.removeChild(obj.parentNode.parentNode);
    
    //등록화면을 보여준다.
    insertFormVisible(true);

  }
  
  function addComment() {
    //새 덧글등록을 위한 다음 아이디 객체 얻기  
    var next_id = document.getElementById("next_id");
    var param = {
      name  : "comment", 
      attributes : [
        { name : "id", value : next_id.value }
      ],
      childNodes : [
        { name : "name"   , value : document.addForm.name.value },
        { name : "content", value : document.addForm.content.value }
      ]
    };     
    next_id.value = parseInt(next_id.value) + 1;
    
    var node = xmlObj.createElement(param);
    xmlObj.appendChild(node);

    var list = document.getElementById("list");
    xmlObj.transformNodes(list, node, true);

  }

  window.onload = function() {
    loadBooks();
  }
  
  </script>
</head>
<body>
<!-- comment의 다음 아이디를 구하기 위한 -->
<input type="hidden" id="next_id" name="next_id" value="11" />

<div id="list"></div>

<div id="insert" >
  <form action="" name="addForm">
      이름: <input type="text" name="name" size="10"><br/>
      내용: <textarea name="content" cols="40" rows="3"></textarea><br/>
      <input type="button" value="등록" onclick="addComment()"/>
  </form>
</div>

<div id="update" style="display: none">
  <form action="" name="updateForm">
      <input type="hidden" name="id" value=""/>
      이름: <input type="text" name="name" size="10"><br/>
      내용: <textarea name="content" cols="40" rows="3"></textarea><br/>
      <input type="button" value="수정" onclick="commentUpdate()"/>
      <input type="button" value="취소" onclick="cancelUpdate()"/>
  </form>
</div>

</body>
</html>