<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title> Directory list </title>
<style>
* {
	font-family:맑은 고딕;
}
#debugDiv {
	width:100%; height:400px; font-size:9pt;
}
.filepath {
	color:blue;
}
.filename {
	color:black;
	padding: 10px;
}
.filesize {
	color:red; width:200px;
}
section {
	border: 1px solid #888;
	-moz-border-radius: 10px;
	-webkit-border-radius: 10px;
	border-radius: 10px;	
	-moz-box-shadow: 10px 10px 5px #888;
	-webkit-box-shadow: 10px 10px 5px #888;
	box-shadow: 10px 10px 5px #888;
	background-color: #eee;
}
nav ul {
	list-style: none;
	padding: 0px;
	display: block;
	clear: right;
	background-color: #666;
	padding-left: 4px;
	height: 24px;
}

nav ul li {
	display: inline;
	padding: 0px 20px 5px 10px;
	height: 24px;
	border-right: 1px solid #ccc;
}

nav ul li a {
	color: #EFD3D3;
	text-decoration: none;
	font-size: 13px;
	font-weight: bold;
}

nav ul li a:hover {
	color: #fff;
}
header h1 {
	font-size: 36px;
	margin: 0px;
}

header h2 {
	font-size: 18px;
	margin: 0px;
	color: #888;
	font-style: italic;
}
a {
	text-decoration: none;
}
a:hover {
	text-shadow: 2px 2px 5px #333;
}
</style>
<script src="../js/jquery-1.5.js"></script>
<script>
var path = "";
var prevPath = "";
var files = new Array();
var currSection = "";

$(document).ready(function(){
	$("#loadingbar").hide();
	$("#localpath").bind("keyup", function(event){
		if (event.keyCode == '13') {
			getFileList();
		}
	});
});

function getFileList()
{
	path = $("#localpath").val();
	if(path != "")
	{
		$.ajax({
			url: "filelistAction.jsp?p=" + path,
			beforeSend: function() {
	            $('#loadingbar').show().fadeIn('fast'); 
	        },
			success: function(data){
				viewData(jQuery.trim(data));
			},
			error: function(xhr, status, error){ 
				alert(error); 
			},
			complete: function() { 
				$("#loadingbar").fadeOut();
		    }
		});
	}
}
function viewData(data)
{
	$("#debugDiv").val(data).hide();
	try{
		files = eval(data);
		prevPath = path;
	}catch(e){
		alert(data)
		$("#localpath").val(prevPath);		
		return;
	}

	$("#fileCnt").html("Total " + files.length);
	$("#filelist").empty();
	$("#complist").empty();
	for(var i=0; i<files.length; i++)
	{
		$("#filelist").append("<li><a href='javascript:void()' onclick='fileAction("+i+", \"PLAY\")'>" 
				+ "<span class='filesize'>" + convertSize(files[i].SIZE) + "</span>"
				+ "<span class='filename'>" + files[i].NAME + "</span>"
				+ "<span class='filepath'>" + files[i].PATH.replace(path, "") + "</span>" 
				+ "</a>"
				+ "<a href='javascript:void()' onclick='fileAction("+i+", \"DEL\")'><span class='filedel'>DEL</span></a>"
				+ "</li>");		
	}
	if(currSection == "sameSizeFileSec")
	{
		sameSizeFile();
	}
	else
	{
		allFile();
	}
}

function sameSizeFile()
{
	$("#allFileSec").hide();
	$("#sameSizeFileSec").show();
	currSection = "sameSizeFileSec";
	
	var compArr = new Array();
	var idx = 0;
	for(var i=0; i<files.length-1; i++)
	{
		var except = false;
		for(var k=0; k<compArr.length; k++)
		{
			if(i == compArr[k])
			{
				except = true;
				break;
			}
		}
		
		var first = true;
		if(!except)
		{
			for(var j=i+1; j<files.length; j++)
			{
				if(files[i].SIZE == files[j].SIZE)
				{
					// 번호 기억
					//alert(i + ", " + j);
					if(first)
					{
						$("#complist").append("<li><a href='javascript:void()' onclick='fileAction("+i+", \"PLAY\")'>" + (i + 1) + ". "
								+ "<span class='filesize'>" + files[i].SIZE + "</span>"
								+ "<span class='filename'>" + files[i].NAME + "</span>"
								+ "<span class='filepath'>" + files[i].PATH.replace(path, "") + "</span>" 
								+ "</a>"
								+ "<a href='javascript:void()' onclick='fileAction("+i+", \"DEL\")'><span class='filedel'>DEL</span></a>"
								+ "</li>");		
						first = false;
					}
					
					
					compArr[idx++] = j;
					
					$("#complist").append("<li><a href='javascript:void()' onclick='fileAction("+j+", \"PLAY\")'>" + (j + 1) + ". "
							+ "<span class='filesize'>" + files[j].SIZE + "</span>"
							+ "<span class='filename'>" + files[j].NAME + "</span>"
							+ "<span class='filepath'>" + files[j].PATH.replace(path, "") + "</span>" 
							+ "</a>"
							+ "<a href='javascript:void()' onclick='fileAction("+i+", \"DEL\")'><span class='filedel'>DEL</span></a>"
							+ "</li>");		
				}
			}
			if(!first)
			{
				$("#complist").append("<br/>");
			}
		}
	}
}
function allFile()
{
	$("#allFileSec").show();
	$("#sameSizeFileSec").hide();
	currSection = "allFileSec";
}
function convertSize(s)
{
	var i = parseInt(s);
	if(i < 1000){
		return i + "B";
	}else if(i < 1000000){
		return Math.round(i/1000) + "KB";
	}else if(i < 1000000000){
		return Math.round(i/1000000) + "MB";
	}else if(i < 1000000000000){
		return roundXL(i/1000000000,2) + "GB";
	}else if(i < 1000000000000000){
		return roundXL(i/1000000000000, 2) + "TB";
	}else{
		return s;
	}
}

//엑셀 스타일의 반올림 함수 정의
function roundXL(n, digits) {
  if (digits >= 0) return parseFloat(n.toFixed(digits)); // 소수부 반올림

  digits = Math.pow(10, digits); // 정수부 반올림
  var t = Math.round(n * digits) / digits;

  return parseFloat(t.toFixed(0));
}

function fileAction(idx, mode)
{
	var uri = files[idx].URI;
//	alert(uri);
	$.ajax({
		url: "fileAction.jsp",
		type: "POST",
		data: "uri=" + uri + "&mode=" + mode, 
		beforeSend: function() {
            $('#loadingbar').show().fadeIn('fast'); 
        },
		success: function(data){
			if(mode == "DEL")
			{
				getFileList();	
			}
		},
		error: function(xhr, status, error){ 
			alert(error); 
		},
		complete: function() { 
			$("#loadingbar").fadeOut();
	    }
	});

	
}
</script>
</head>
<body>

<header>
	<hgroup>
		<h1>Directory list</h1>
		<h2>Path : <input id="localpath" placeholder="input local path" value="E:/av"/>
			<input type="button" value="Get file list" onclick="getFileList()"/>
		</h2>
	</hgroup>
</header>

<nav>
	<ul>
		<li><a href="javascript:void()" onclick="allFile()">All file</a></li>
		<li><a href="javascript:void()" onclick="sameSizeFile()">Same size file</a></li>
	</ul>
</nav>

<section id="allFileSec" style="display:none">
	<header>
		<h4 id="fileCnt"></h4>
	</header>
	<ol id="filelist">
	</ol>
</section>

<section id="sameSizeFileSec" style="display:none">
	<ul id="complist">
	</ul>
</section>


<textarea id="debugDiv" style="display:none;"></textarea>

<div id="loadingbar" style="position: absolute; left:0px; top:0px;height: 100%; width: 100%;z-index: 99; display:none;">
	<table width="100%" height="100%"> 
		<TR valign="middle"> 
			<TD align="center"> 
				<img src="./loading.gif">
			</TD> 
		</TR> 
	</TABLE> 
</div>
</body>
</html>